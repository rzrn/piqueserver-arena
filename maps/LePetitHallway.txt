# Copyright © 2025–2026 rzrn

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.

# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

from pyspades.vxl import VXLData
from itertools import product
from random import Random

from pyspades.common import make_color

from arenalib.maptools import HSV3fAsRGB3i

name    = 'LePetitHallway'
author  = 'izzy (orig.)'
version = '1.0'

extensions = dict(
    arena             = True,
    arena_blue_spawn  = (256 - 70, 256, 62),
    arena_green_spawn = (256 + 70, 256, 62),
    water_damage      = 100
)

y1, y2, length = 3, 8, 64

assert y1 < y2

mask = None

def is_indestructable(connection, x, y, z):
    return bool(mask.get_solid(x, y, z))

def gen_script(basename, seed):
    global fog

    rgen = Random(seed)

    hue = rgen.uniform(0.0, 1.0)

    fog   = HSV3fAsRGB3i(hue, 0.50, 1.00)
    water = HSV3fAsRGB3i(hue, 0.35, 1.00)
    walls = HSV3fAsRGB3i(hue, 0.80, 1.00)

    vxl = VXLData()

    for x, y in product(range(512), range(512)):
        vxl.set_point(x, y, 63, water)

    color = make_color(*walls)

    for Δx, Δy in product(range(-64 - 13, 64 + 13), range(-6, 7)):
        Δz = 0 if Δx < -64 or 64 <= Δx or -3 <= Δy <= 3 else 62
        vxl.set_column_fast(256 + Δx, 256 + Δy, 62 - Δz, 63, 63, color)

    global mask
    mask = vxl.copy()

    return vxl
